<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:FloofLog.ViewModels"
             xmlns:models="clr-namespace:FloofLog.Models"
             xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
             xmlns:converters="clr-namespace:FloofLog.Converters"
             xmlns:selectors="clr-namespace:FloofLog.Selectors"
             x:Class="FloofLog.MainPage"
             x:Name="DashboardPage"
             x:DataType="viewModels:MainPageViewModel"
             Title="Dashboard">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:ActivityIconConverter x:Key="ActivityIconConverter" />
            <converters:ReminderStatusConverter x:Key="ReminderStatusConverter" />

            <DataTemplate x:Key="ActivityTemplate" x:DataType="models:PetActivity">
                <SwipeView>
                    <SwipeView.RightItems>
                        <SwipeItems Mode="Reveal">
                            <SwipeItem Text="Edit"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.EditActivityCommand}"
                                       CommandParameter="{Binding .}" />
                            <SwipeItem Text="Delete"
                                       BackgroundColor="Tomato"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.DeleteActivityCommand}"
                                       CommandParameter="{Binding .}" />
                        </SwipeItems>
                    </SwipeView.RightItems>

                    <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            StrokeShape="{shapes:RoundRectangle CornerRadius=16}"
                            Padding="16"
                            Margin="0,0,0,12">
                        <Grid ColumnDefinitions="Auto,*"
                              ColumnSpacing="12">
                            <Label Text="{Binding ., Converter={StaticResource ActivityIconConverter}}"
                                   FontSize="28"
                                   VerticalOptions="Center" />

                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding DisplayName}"
                                       FontAttributes="Bold"
                                       FontSize="16" />
                                <Label Text="{Binding Notes}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
                                       LineBreakMode="WordWrap">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="{x:Null}">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                                <Label Text="{Binding OccurredAt, StringFormat='{}{0:MMM d, h:mm tt}'}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
                            </VerticalStackLayout>
                        </Grid>
                    </Border>
                </SwipeView>
            </DataTemplate>

            <DataTemplate x:Key="UpcomingReminderTemplate" x:DataType="models:PetReminder">
                <SwipeView>
                    <SwipeView.RightItems>
                        <SwipeItems Mode="Reveal">
                            <SwipeItem Text="Edit"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.EditReminderCommand}"
                                       CommandParameter="{Binding .}" />
                            <SwipeItem Text="Delete"
                                       BackgroundColor="Tomato"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.DeleteReminderCommand}"
                                       CommandParameter="{Binding .}" />
                        </SwipeItems>
                    </SwipeView.RightItems>

                    <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            StrokeShape="{shapes:RoundRectangle CornerRadius=16}"
                            Padding="16"
                            Margin="0,0,0,12">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding DisplayName}"
                                   FontAttributes="Bold"
                                   FontSize="16" />
                            <Label Text="{Binding ., Converter={StaticResource ReminderStatusConverter}}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
                            <Label Text="{Binding RemindAt, StringFormat='{}{0:MMM d, h:mm tt}'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding RemindAt}" Value="{x:Null}">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                            <Label Text="{Binding Notes}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
                                   LineBreakMode="WordWrap">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="{x:Null}">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </VerticalStackLayout>
                    </Border>
                </SwipeView>
            </DataTemplate>

            <DataTemplate x:Key="OverdueReminderTemplate" x:DataType="models:PetReminder">
                <SwipeView>
                    <SwipeView.RightItems>
                        <SwipeItems Mode="Reveal">
                            <SwipeItem Text="Edit"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.EditReminderCommand}"
                                       CommandParameter="{Binding .}" />
                            <SwipeItem Text="Delete"
                                       BackgroundColor="Tomato"
                                       Command="{Binding Source={x:Reference DashboardPage}, Path=BindingContext.DeleteReminderCommand}"
                                       CommandParameter="{Binding .}" />
                        </SwipeItems>
                    </SwipeView.RightItems>

                    <Border Stroke="Tomato"
                            BackgroundColor="{AppThemeBinding Light=#33FF6F60, Dark=#66FF6F60}"
                            StrokeShape="{shapes:RoundRectangle CornerRadius=16}"
                            Padding="16"
                            Margin="0,0,0,12">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding DisplayName}"
                                   FontAttributes="Bold"
                                   FontSize="16" />
                            <Label Text="{Binding ., Converter={StaticResource ReminderStatusConverter}}"
                                   FontAttributes="Bold"
                                   FontSize="12"
                                   TextColor="Tomato" />
                            <Label Text="{Binding RemindAt, StringFormat='{}{0:MMM d, h:mm tt}'}"
                                   FontSize="12"
                                   TextColor="Tomato">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding RemindAt}" Value="{x:Null}">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                            <Label Text="{Binding Notes}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                   LineBreakMode="WordWrap">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding Notes}" Value="{x:Null}">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </VerticalStackLayout>
                    </Border>
                </SwipeView>
            </DataTemplate>

            <selectors:ReminderTemplateSelector x:Key="ReminderTemplateSelector"
                                                UpcomingTemplate="{StaticResource UpcomingReminderTemplate}"
                                                OverdueTemplate="{StaticResource OverdueReminderTemplate}" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Log Feeding"
                     Order="Primary"
                     Priority="0"
                     Command="{Binding LogFeedingCommand}" />
        <ToolbarItem Text="Log Activity"
                     Order="Primary"
                     Priority="1"
                     Command="{Binding AddActivityCommand}" />
        <ToolbarItem Text="Schedule Reminder"
                     Order="Primary"
                     Priority="2"
                     Command="{Binding ScheduleReminderCommand}" />
    </ContentPage.ToolbarItems>

    <RefreshView Command="{Binding RefreshCommand}"
                 IsRefreshing="{Binding IsBusy}">
        <ScrollView>
            <VerticalStackLayout Padding="24"
                                  Spacing="20">
                <Label Text="Welcome back!"
                       Style="{StaticResource Headline}" />

                <Grid ColumnDefinitions="*,*"
                      RowDefinitions="Auto,Auto"
                      ColumnSpacing="16"
                      RowSpacing="16">
                    <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            Padding="16">
                        <Border.StrokeShape>
                            <shapes:RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Last feeding"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray200}}" />
                            <Label Text="{Binding LastFeedingSummary}"
                                   FontSize="16"
                                   LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Column="1"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            Padding="16">
                        <Border.StrokeShape>
                            <shapes:RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Next walk"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray200}}" />
                            <Label Text="{Binding NextWalkSummary}"
                                   FontSize="16"
                                   LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Row="1"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            Padding="16">
                        <Border.StrokeShape>
                            <shapes:RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Pets in your care"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray200}}" />
                            <Label Text="{Binding TotalPets}"
                                   FontSize="28"
                                   FontAttributes="Bold" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Row="1"
                            Grid.Column="1"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                            Padding="16">
                        <Border.StrokeShape>
                            <shapes:RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Today’s activity count"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray200}}" />
                            <Label Text="{Binding ActivitiesLoggedToday}"
                                   FontSize="28"
                                   FontAttributes="Bold" />
                            <Label Text="Pending reminders: {Binding PendingReminders}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <Label Text="Recent Activities"
                       Style="{StaticResource SubHeadline}" />
                <CollectionView ItemsSource="{Binding RecentActivities}"
                                ItemTemplate="{StaticResource ActivityTemplate}"
                                SelectionMode="None">
                    <CollectionView.EmptyView>
                        <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                                StrokeShape="{shapes:RoundRectangle CornerRadius=16}"
                                Padding="24">
                            <VerticalStackLayout Spacing="8"
                                                  HorizontalOptions="Center"
                                                  VerticalOptions="Center">
                                <Label Text="No activities yet"
                                       FontAttributes="Bold"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Log your first activity from the toolbar to start building your pet’s history."
                                       HorizontalTextAlignment="Center"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
                            </VerticalStackLayout>
                        </Border>
                    </CollectionView.EmptyView>
                </CollectionView>

                <Label Text="Upcoming Reminders"
                       Style="{StaticResource SubHeadline}" />
                <CollectionView ItemsSource="{Binding UpcomingReminders}"
                                ItemTemplate="{StaticResource ReminderTemplateSelector}"
                                SelectionMode="None">
                    <CollectionView.EmptyView>
                        <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                                StrokeShape="{shapes:RoundRectangle CornerRadius=16}"
                                Padding="24">
                            <VerticalStackLayout Spacing="8"
                                                  HorizontalOptions="Center"
                                                  VerticalOptions="Center">
                                <Label Text="No reminders scheduled"
                                       FontAttributes="Bold"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Use the toolbar to schedule the next walk, medication, or grooming session."
                                       HorizontalTextAlignment="Center"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
                            </VerticalStackLayout>
                        </Border>
                    </CollectionView.EmptyView>
                </CollectionView>

                <Label Text="{Binding StatusMessage}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
